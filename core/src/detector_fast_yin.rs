use crate::detector::{PitchDetectionResult, PitchDetector};
use rustfft::num_complex::Complex;
use rustfft::{Fft, FftPlanner};

struct FastYin {
    sample_rate: f32,
    buffer_size: usize,
    threshold: f32,

    yin_buffer: Vec<f32>,

    fft_forward: std::sync::Arc<dyn Fft<f32>>,
    fft_inverse: std::sync::Arc<dyn Fft<f32>>,

    audio_buffer_fft: Vec<Complex<f32>>,
    kernel: Vec<Complex<f32>>,
    yin_style_acf: Vec<Complex<f32>>,

    result: PitchDetectionResult,
}

impl PitchDetector for FastYin {
    fn get_pitch(&mut self, audio_buffer: &[f32]) -> PitchDetectionResult {
        self.difference(audio_buffer);
        self.cumulative_mean_normalized_difference();

        if let Some(tau_estimate) = self.absolute_threshold() {
            let better_tau = self.parabolic_interpolation(tau_estimate);
            self.result.frequency = self.sample_rate / better_tau;
            self.result.pitched = true;
        } else {
            self.result.frequency = -1.0;
            self.result.pitched = false;
        }

        self.result.clone()
    }
}

impl FastYin {
    pub fn new(sample_rate: f32, buffer_size: usize, threshold: f32) -> Self {
        let buffer_size_half = buffer_size / 2;
        let mut fft_planner = FftPlanner::new();
        let fft_forward = fft_planner.plan_fft_forward(buffer_size);
        let fft_inverse = fft_planner.plan_fft_inverse(buffer_size);
        let complex_zero_buffer = vec![Complex::new(0.0, 0.0); buffer_size];

        Self {
            sample_rate,
            buffer_size,
            threshold,
            yin_buffer: vec![0.0; buffer_size_half],
            fft_forward,
            fft_inverse,
            audio_buffer_fft: complex_zero_buffer.clone(),
            kernel: complex_zero_buffer.clone(),
            yin_style_acf: complex_zero_buffer,
            result: PitchDetectionResult::default(),
        }
    }

    fn difference(&mut self, audio_buffer: &[f32]) {
        assert!(audio_buffer.len() >= self.buffer_size);
        let window_size = self.yin_buffer.len();

        let mut power_terms = vec![0.0; window_size];
        for j in 0..window_size {
            power_terms[j] += audio_buffer[j] * audio_buffer[j];
        }

        for tau in 1..window_size {
            power_terms[tau] = power_terms[tau - 1] - audio_buffer[tau - 1] * audio_buffer[tau - 1]
                + audio_buffer[tau + window_size] * audio_buffer[tau + window_size];
        }

        self.audio_buffer_fft
            .iter_mut()
            .enumerate()
            .for_each(|(i, c)| {
                *c = Complex::new(audio_buffer[i], 0.0);
            });
        self.fft_forward.process(&mut self.audio_buffer_fft);
        for (i, c) in self.kernel.iter_mut().enumerate() {
            *c = if i < window_size {
                Complex::new(audio_buffer[window_size - 1 - i], 0.0)
            } else {
                Complex::new(0.0, 0.0)
            };
        }
        self.fft_forward.process(&mut self.kernel);

        for (i, c) in self.yin_style_acf.iter_mut().enumerate() {
            *c = self.audio_buffer_fft[i] * self.kernel[i];
        }
        self.fft_inverse.process(&mut self.yin_style_acf);

        for (i, y) in self.yin_buffer.iter_mut().enumerate() {
            *y = power_terms[0] + power_terms[i]
                - 2.0 * self.yin_style_acf[2 * (window_size - 1 + i)].re;
        }
    }

    fn cumulative_mean_normalized_difference(&mut self) {
        let mut running_sum = 0.0;
        self.yin_buffer[0] = 1.0;

        for tau in 1..self.yin_buffer.len() {
            running_sum += self.yin_buffer[tau];
            self.yin_buffer[tau] *= tau as f32 / running_sum;
        }
    }

    fn absolute_threshold(&mut self) -> Option<usize> {
        let mut tau = 2usize;
        while tau < self.yin_buffer.len() {
            if self.yin_buffer[tau] < self.threshold {
                while tau + 1 < self.yin_buffer.len()
                    && self.yin_buffer[tau + 1] < self.yin_buffer[tau]
                {
                    tau += 1;
                }
                self.result.probability = 1.0 - self.yin_buffer[tau];
                break;
            }
            tau += 1;
        }

        if tau == self.yin_buffer.len()
            || self.yin_buffer[tau] >= self.threshold
            || self.result.probability > 1.0
        {
            None
        } else {
            Some(tau)
        }
    }

    fn parabolic_interpolation(&self, tau_estimate: usize) -> f32 {
        let x0: usize = if tau_estimate < 1 {
            tau_estimate
        } else {
            tau_estimate - 1
        };
        let x2: usize = if tau_estimate + 1 < self.yin_buffer.len() {
            tau_estimate + 1
        } else {
            tau_estimate
        };

        if x0 == tau_estimate {
            if self.yin_buffer[tau_estimate] <= self.yin_buffer[x2] {
                tau_estimate as f32
            } else {
                x2 as f32
            }
        } else if x2 == tau_estimate {
            if self.yin_buffer[tau_estimate] <= self.yin_buffer[x0] {
                tau_estimate as f32
            } else {
                x0 as f32
            }
        } else {
            let s0 = self.yin_buffer[x0];
            let s1 = self.yin_buffer[tau_estimate];
            let s2 = self.yin_buffer[x2];
            tau_estimate as f32 + (s2 - s0) / (2.0 * (2.0 * s1 - s2 - s0))
        }
    }
}

#[cfg(test)]
mod test {
    use rustfft::{num_complex::Complex, FftPlanner};

    #[test]
    fn test_saturating_sub() {
        let a: usize = 88;
        println!("a: {}", a.saturating_sub(1))
    }

    #[test]
    fn test_fft() {
        let n = 1024;
        let mut planner = FftPlanner::new();
        let fft = planner.plan_fft_forward(n);

        let mut buffer: Vec<Complex<f32>> =
            (0..n).map(|i| Complex::new(i as f32 * 2.0, 0.0)).collect();

        fft.process(&mut buffer);
        println!("result: {:?}", buffer);
        let expected = [
            1047552.0,
            0.0,
            -1024.0,
            333771.06,
            -1024.0,
            166883.97,
            -1024.0,
            111254.234,
            -1024.0,
            83438.836,
            -1024.0,
            66749.18,
            -1024.0,
            55622.406,
            -1024.0,
            47674.4,
            -1024.0,
            41713.133,
            -1024.0,
            37076.367,
            -1024.0,
            33366.734,
            -1024.0,
            30331.398,
            -1024.0,
            27801.777,
            -1024.0,
            25661.164,
            -1024.0,
            23826.201,
            -1024.0,
            22235.766,
            -1024.0,
            20843.998,
            -1024.0,
            19615.852,
            -1024.0,
            18524.041,
            -1024.0,
            17547.05,
            -1024.0,
            16667.654,
            -1024.0,
            15871.911,
            -1024.0,
            15148.415,
            -1024.0,
            14487.738,
            -1024.0,
            13882.03,
            -1024.0,
            13324.695,
            -1024.0,
            12810.15,
            -1024.0,
            12333.643,
            -1024.0,
            11891.095,
            -1024.0,
            11478.996,
            -1024.0,
            11094.305,
            -1024.0,
            10734.352,
            -1024.0,
            10396.846,
            -1024.0,
            10079.723,
            -1024.0,
            9781.199,
            -1024.0,
            9499.665,
            -1024.0,
            9233.719,
            -1024.0,
            8982.089,
            -1024.0,
            8743.646,
            -1024.0,
            8517.377,
            -1024.0,
            8302.372,
            -1024.0,
            8097.802,
            -1024.0,
            7902.924,
            -1024.0,
            7717.0605,
            -1024.0,
            7539.5977,
            -1024.0,
            7369.975,
            -1024.0,
            7207.6807,
            -1024.0,
            7052.2495,
            -1024.0,
            6903.2476,
            -1024.0,
            6760.287,
            -1024.0,
            6623.0,
            -1024.0,
            6491.0596,
            -1024.0,
            6364.1475,
            -1024.0,
            6241.9873,
            -1024.0,
            6124.3135,
            -1024.0,
            6010.874,
            -1024.0,
            5901.456,
            -1024.0,
            5795.84,
            -1024.0,
            5693.824,
            -1024.0,
            5595.2354,
            -1024.0,
            5499.895,
            -1024.0,
            5407.6465,
            -1024.0,
            5318.334,
            -1024.0,
            5231.835,
            -1024.0,
            5147.9956,
            -1024.0,
            5066.702,
            -1024.0,
            4987.847,
            -1024.0,
            4911.3125,
            -1024.0,
            4836.9966,
            -1024.0,
            4764.8066,
            -1024.0,
            4694.6416,
            -1024.0,
            4626.425,
            -1024.0,
            4560.08,
            -1024.0,
            4495.5186,
            -1024.0,
            4432.673,
            -1024.0,
            4371.48,
            -1024.0,
            4311.8613,
            -1024.0,
            4253.7666,
            -1024.0,
            4197.133,
            -1024.0,
            4141.9106,
            -1024.0,
            4088.0369,
            -1024.0,
            4035.4678,
            -1024.0,
            3984.1562,
            -1024.0,
            3934.0547,
            -1024.0,
            3885.1216,
            -1024.0,
            3837.3115,
            -1024.0,
            3790.5913,
            -1024.0,
            3744.914,
            -1024.0,
            3700.2612,
            -1024.0,
            3656.5825,
            -1024.0,
            3613.849,
            -1024.0,
            3572.0342,
            -1024.0,
            3531.0996,
            -1024.0,
            3491.024,
            -1024.0,
            3451.7822,
            -1024.0,
            3413.3452,
            -1024.0,
            3375.6753,
            -1024.0,
            3338.7651,
            -1024.0,
            3302.5898,
            -1024.0,
            3267.1196,
            -1024.0,
            3232.3381,
            -1024.0,
            3198.2227,
            -1024.0,
            3164.7583,
            -1024.0,
            3131.921,
            -1024.0,
            3099.692,
            -1024.0,
            3068.0586,
            -1024.0,
            3036.9998,
            -1024.0,
            3006.5,
            -1024.0,
            2976.5493,
            -1024.0,
            2947.127,
            -1024.0,
            2918.214,
            -1024.0,
            2889.8096,
            -1024.0,
            2861.8877,
            -1024.0,
            2834.4453,
            -1024.0,
            2807.4602,
            -1024.0,
            2780.9248,
            -1024.0,
            2754.832,
            -1024.0,
            2729.163,
            -1024.0,
            2703.914,
            -1024.0,
            2679.0674,
            -1024.0,
            2654.6191,
            -1024.0,
            2630.5571,
            -1024.0,
            2606.8677,
            -1024.0,
            2583.5479,
            -1024.0,
            2560.5845,
            -1024.0,
            2537.9688,
            -1024.0,
            2515.7012,
            -1024.0,
            2493.7717,
            -1024.0,
            2472.1548,
            -1024.0,
            2450.856,
            -1024.0,
            2429.8716,
            -1024.0,
            2409.1973,
            -1024.0,
            2388.811,
            -1024.0,
            2368.7195,
            -1024.0,
            2348.9053,
            -1024.0,
            2329.3691,
            -1024.0,
            2310.1074,
            -1024.0,
            2291.1094,
            -1024.0,
            2272.37,
            -1024.0,
            2253.8804,
            -1024.0,
            2235.642,
            -1024.0,
            2217.645,
            -1024.0,
            2199.8882,
            -1024.0,
            2182.3586,
            -1024.0,
            2165.0664,
            -1024.0,
            2147.9927,
            -1024.0,
            2131.1355,
            -1024.0,
            2114.4912,
            -1024.0,
            2098.058,
            -1024.0,
            2081.831,
            -1024.0,
            2065.8074,
            -1024.0,
            2049.9756,
            -1024.0,
            2034.3387,
            -1024.0,
            2018.8938,
            -1024.0,
            2003.6305,
            -1024.0,
            1988.5553,
            -1024.0,
            1973.6525,
            -1024.0,
            1958.9287,
            -1024.0,
            1944.372,
            -1024.0,
            1929.9908,
            -1024.0,
            1915.7688,
            -1024.0,
            1901.7098,
            -1024.0,
            1887.8145,
            -1024.0,
            1874.0742,
            -1024.0,
            1860.485,
            -1024.0,
            1847.0459,
            -1024.0,
            1833.7583,
            -1024.0,
            1820.6113,
            -1024.0,
            1807.613,
            -1024.0,
            1794.7506,
            -1024.0,
            1782.0275,
            -1024.0,
            1769.4374,
            -1024.0,
            1756.9818,
            -1024.0,
            1744.6556,
            -1024.0,
            1732.4574,
            -1024.0,
            1720.3818,
            -1024.0,
            1708.4413,
            -1024.0,
            1696.6151,
            -1024.0,
            1684.9089,
            -1024.0,
            1673.3214,
            -1024.0,
            1661.8474,
            -1024.0,
            1650.4889,
            -1024.0,
            1639.241,
            -1024.0,
            1628.104,
            -1024.0,
            1617.0723,
            -1024.0,
            1606.147,
            -1024.0,
            1595.3312,
            -1024.0,
            1584.6163,
            -1024.0,
            1574.0038,
            -1024.0,
            1563.4889,
            -1024.0,
            1553.0732,
            -1024.0,
            1542.7495,
            -1024.0,
            1532.5242,
            -1024.0,
            1522.3954,
            -1024.0,
            1512.3528,
            -1024.0,
            1502.4,
            -1024.0,
            1492.5438,
            -1024.0,
            1482.7704,
            -1024.0,
            1473.0851,
            -1024.0,
            1463.4843,
            -1024.0,
            1453.9689,
            -1024.0,
            1444.5356,
            -1024.0,
            1435.1807,
            -1024.0,
            1425.9089,
            -1024.0,
            1416.7145,
            -1024.0,
            1407.597,
            -1024.0,
            1398.5581,
            -1024.0,
            1389.5989,
            -1024.0,
            1380.7041,
            -1024.0,
            1371.8842,
            -1024.0,
            1363.1447,
            -1024.0,
            1354.4719,
            -1024.0,
            1345.8665,
            -1024.0,
            1337.332,
            -1024.0,
            1328.8646,
            -1024.0,
            1320.4635,
            -1024.0,
            1312.1353,
            -1024.0,
            1303.87,
            -1024.0,
            1295.6648,
            -1024.0,
            1287.5298,
            -1024.0,
            1279.4456,
            -1024.0,
            1271.4323,
            -1024.0,
            1263.4813,
            -1024.0,
            1255.5787,
            -1024.0,
            1247.7474,
            -1024.0,
            1239.9719,
            -1024.0,
            1232.2548,
            -1024.0,
            1224.5867,
            -1024.0,
            1216.9827,
            -1024.0,
            1209.4304,
            -1024.0,
            1201.9326,
            -1024.0,
            1194.4905,
            -1024.0,
            1187.1007,
            -1024.0,
            1179.7605,
            -1024.0,
            1172.4766,
            -1024.0,
            1165.2426,
            -1024.0,
            1158.0577,
            -1024.0,
            1150.9242,
            -1024.0,
            1143.8378,
            -1024.0,
            1136.8032,
            -1024.0,
            1129.8091,
            -1024.0,
            1122.865,
            -1024.0,
            1115.9731,
            -1024.0,
            1109.1226,
            -1024.0,
            1102.3169,
            -1024.0,
            1095.5571,
            -1024.0,
            1088.8408,
            -1024.0,
            1082.167,
            -1024.0,
            1075.5403,
            -1024.0,
            1068.9537,
            -1024.0,
            1062.4088,
            -1024.0,
            1055.9094,
            -1024.0,
            1049.4434,
            -1024.0,
            1043.0234,
            -1024.0,
            1036.6448,
            -1024.0,
            1030.3047,
            -1024.0,
            1024.0,
            -1024.0,
            1017.73047,
            -1024.0,
            1011.50745,
            -1024.0,
            1005.3214,
            -1024.0,
            999.1698,
            -1024.0,
            993.0532,
            -1024.0,
            986.97876,
            -1024.0,
            980.9336,
            -1024.0,
            974.92847,
            -1024.0,
            968.9618,
            -1024.0,
            963.02124,
            -1024.0,
            957.1177,
            -1024.0,
            951.24744,
            -1024.0,
            945.4116,
            -1024.0,
            939.60815,
            -1024.0,
            933.8396,
            -1024.0,
            928.09973,
            -1024.0,
            922.3906,
            -1024.0,
            916.719,
            -1024.0,
            911.073,
            -1024.0,
            905.46155,
            -1024.0,
            899.8806,
            -1024.0,
            894.3257,
            -1024.0,
            888.8009,
            -1024.0,
            883.30774,
            -1024.0,
            877.8439,
            -1024.0,
            872.407,
            -1024.0,
            867.0017,
            -1024.0,
            861.62,
            -1024.0,
            856.2671,
            -1024.0,
            850.93896,
            -1024.0,
            845.6405,
            -1024.0,
            840.37537,
            -1024.0,
            835.1306,
            -1024.0,
            829.9115,
            -1024.0,
            824.7179,
            -1024.0,
            819.55347,
            -1024.0,
            814.4127,
            -1024.0,
            809.29626,
            -1024.0,
            804.2074,
            -1024.0,
            799.13696,
            -1024.0,
            794.09485,
            -1024.0,
            789.0758,
            -1024.0,
            784.0792,
            -1024.0,
            779.11,
            -1024.0,
            774.16064,
            -1024.0,
            769.23413,
            -1024.0,
            764.33875,
            -1024.0,
            759.45044,
            -1024.0,
            754.5928,
            -1024.0,
            749.7562,
            -1024.0,
            744.93994,
            -1024.0,
            740.1467,
            -1024.0,
            735.37476,
            -1024.0,
            730.625,
            -1024.0,
            725.89026,
            -1024.0,
            721.1821,
            -1024.0,
            716.4922,
            -1024.0,
            711.82385,
            -1024.0,
            707.1752,
            -1024.0,
            702.54126,
            -1024.0,
            697.93506,
            -1024.0,
            693.3424,
            -1024.0,
            688.76465,
            -1024.0,
            684.21484,
            -1024.0,
            679.6821,
            -1024.0,
            675.1615,
            -1024.0,
            670.6658,
            -1024.0,
            666.18494,
            -1024.0,
            661.7213,
            -1024.0,
            657.27905,
            -1024.0,
            652.85156,
            -1024.0,
            648.4407,
            -1024.0,
            644.0453,
            -1024.0,
            639.6708,
            -1024.0,
            635.3136,
            -1024.0,
            630.9695,
            -1024.0,
            626.6439,
            -1024.0,
            622.33203,
            -1024.0,
            618.0338,
            -1024.0,
            613.7622,
            -1024.0,
            609.5,
            -1024.0,
            605.25354,
            -1024.0,
            601.01965,
            -1024.0,
            596.80505,
            -1024.0,
            592.6039,
            -1024.0,
            588.41797,
            -1024.0,
            584.24634,
            -1024.0,
            580.0884,
            -1024.0,
            575.94666,
            -1024.0,
            571.8179,
            -1024.0,
            567.7019,
            -1024.0,
            563.6028,
            -1024.0,
            559.51416,
            -1024.0,
            555.4409,
            -1024.0,
            551.38574,
            -1024.0,
            547.3396,
            -1024.0,
            543.3042,
            -1024.0,
            539.2877,
            -1024.0,
            535.28015,
            -1024.0,
            531.2871,
            -1024.0,
            527.306,
            -1024.0,
            523.33813,
            -1024.0,
            519.3811,
            -1024.0,
            515.4387,
            -1024.0,
            511.50867,
            -1024.0,
            507.58765,
            -1024.0,
            503.6814,
            -1024.0,
            499.78333,
            -1024.0,
            495.89868,
            -1024.0,
            492.02832,
            -1024.0,
            488.16272,
            -1024.0,
            484.3152,
            -1024.0,
            480.4729,
            -1024.0,
            476.64648,
            -1024.0,
            472.83203,
            -1024.0,
            469.02563,
            -1024.0,
            465.22913,
            -1024.0,
            461.44617,
            -1024.0,
            457.6725,
            -1024.0,
            453.9077,
            -1024.0,
            450.15283,
            -1024.0,
            446.41162,
            -1024.0,
            442.67773,
            -1024.0,
            438.953,
            -1024.0,
            435.24023,
            -1024.0,
            431.5332,
            -1024.0,
            427.82727,
            -1024.0,
            424.15466,
            -1024.0,
            420.47754,
            -1024.0,
            416.81433,
            -1024.0,
            413.156,
            -1024.0,
            409.5044,
            -1024.0,
            405.86377,
            -1024.0,
            402.23376,
            -1024.0,
            398.61267,
            -1024.0,
            395.0005,
            -1024.0,
            391.39575,
            -1024.0,
            387.7987,
            -1024.0,
            384.2124,
            -1024.0,
            380.63074,
            -1024.0,
            377.0592,
            -1024.0,
            373.49622,
            -1024.0,
            369.93982,
            -1024.0,
            366.3933,
            -1024.0,
            362.85645,
            -1024.0,
            359.3208,
            -1024.0,
            355.79614,
            -1024.0,
            352.27856,
            -1024.0,
            348.7671,
            -1024.0,
            345.26758,
            -1024.0,
            341.76953,
            -1024.0,
            338.28406,
            -1024.0,
            334.80505,
            -1024.0,
            331.32874,
            -1024.0,
            327.86072,
            -1024.0,
            324.4015,
            -1024.0,
            320.9496,
            -1024.0,
            317.50415,
            -1024.0,
            314.06128,
            -1024.0,
            310.62708,
            -1024.0,
            307.19983,
            -1024.0,
            303.77673,
            -1024.0,
            300.36072,
            -1024.0,
            296.95605,
            -1024.0,
            293.55408,
            -1024.0,
            290.15686,
            -1024.0,
            286.76257,
            -1024.0,
            283.3794,
            -1024.0,
            279.99805,
            -1024.0,
            276.62537,
            -1024.0,
            273.2567,
            -1024.0,
            269.89514,
            -1024.0,
            266.5381,
            -1024.0,
            263.18335,
            -1024.0,
            259.83398,
            -1024.0,
            256.4989,
            -1024.0,
            253.16284,
            -1024.0,
            249.83264,
            -1024.0,
            246.5061,
            -1024.0,
            243.18433,
            -1024.0,
            239.87036,
            -1024.0,
            236.5586,
            -1024.0,
            233.24951,
            -1024.0,
            229.94653,
            -1024.0,
            226.64893,
            -1024.0,
            223.35669,
            -1024.0,
            220.06616,
            -1024.0,
            216.78491,
            -1024.0,
            213.50562,
            -1024.0,
            210.22803,
            -1024.0,
            206.95801,
            -1024.0,
            203.68604,
            -1024.0,
            200.41626,
            -1024.0,
            197.16333,
            -1024.0,
            193.9082,
            -1024.0,
            190.65503,
            -1024.0,
            187.40576,
            -1024.0,
            184.15869,
            -1024.0,
            180.91797,
            -1024.0,
            177.68042,
            -1024.0,
            174.4458,
            -1024.0,
            171.21436,
            -1024.0,
            167.98584,
            -1024.0,
            164.76196,
            -1024.0,
            161.5415,
            -1024.0,
            158.32422,
            -1024.0,
            155.10205,
            -1024.0,
            151.896,
            -1024.0,
            148.68848,
            -1024.0,
            145.47949,
            -1024.0,
            142.27856,
            -1024.0,
            139.07593,
            -1024.0,
            135.87793,
            -1024.0,
            132.68286,
            -1024.0,
            129.4895,
            -1024.0,
            126.29785,
            -1024.0,
            123.11035,
            -1024.0,
            119.92529,
            -1024.0,
            116.739746,
            -1024.0,
            113.56006,
            -1024.0,
            110.37988,
            -1024.0,
            107.20264,
            -1024.0,
            104.02881,
            -1024.0,
            100.85498,
            -1024.0,
            97.68457,
            -1024.0,
            94.512695,
            -1024.0,
            91.3457,
            -1024.0,
            88.18213,
            -1024.0,
            85.01611,
            -1024.0,
            81.85596,
            -1024.0,
            78.69238,
            -1024.0,
            75.53516,
            -1024.0,
            72.37598,
            -1024.0,
            69.21973,
            -1024.0,
            66.06201,
            -1024.0,
            62.911133,
            -1024.0,
            59.756836,
            -1024.0,
            56.604492,
            -1024.0,
            53.458008,
            -1024.0,
            50.30664,
            -1024.0,
            47.160156,
            -1024.0,
            44.010742,
            -1024.0,
            40.86133,
            -1024.0,
            37.71582,
            -1024.0,
            34.57129,
            -1024.0,
            31.427734,
            -1024.0,
            28.285156,
            -1024.0,
            25.136719,
            -1024.0,
            21.992188,
            -1024.0,
            18.851562,
            -1024.0,
            15.707031,
            -1024.0,
            12.566406,
            -1024.0,
            9.421875,
            -1024.0,
            6.296875,
            -1024.0,
            3.125,
            -1024.0,
            -0.0,
            -1024.0,
            -3.125,
            -1024.0,
            -6.2890625,
            -1024.0,
            -9.421875,
            -1024.0,
            -12.5703125,
            -1024.0,
            -15.7109375,
            -1024.0,
            -18.851562,
            -1024.0,
            -21.99414,
            -1024.0,
            -25.138672,
            -1024.0,
            -28.283203,
            -1024.0,
            -31.427734,
            -1024.0,
            -34.569336,
            -1024.0,
            -37.714844,
            -1024.0,
            -40.862305,
            -1024.0,
            -44.01172,
            -1024.0,
            -47.15625,
            -1024.0,
            -50.30664,
            -1024.0,
            -53.45215,
            -1024.0,
            -56.603516,
            -1024.0,
            -59.757812,
            -1024.0,
            -62.910156,
            -1024.0,
            -66.06348,
            -1024.0,
            -69.21973,
            -1024.0,
            -72.376465,
            -1024.0,
            -75.53613,
            -1024.0,
            -78.69531,
            -1024.0,
            -81.85547,
            -1024.0,
            -85.015625,
            -1024.0,
            -88.18262,
            -1024.0,
            -91.348145,
            -1024.0,
            -94.51514,
            -1024.0,
            -97.68359,
            -1024.0,
            -100.85498,
            -1024.0,
            -104.02783,
            -1024.0,
            -107.20557,
            -1024.0,
            -110.381836,
            -1024.0,
            -113.558105,
            -1024.0,
            -116.743164,
            -1024.0,
            -119.92432,
            -1024.0,
            -123.11084,
            -1024.0,
            -126.298096,
            -1024.0,
            -129.48926,
            -1024.0,
            -132.68066,
            -1024.0,
            -135.87793,
            -1024.0,
            -139.0752,
            -1024.0,
            -142.27686,
            -1024.0,
            -145.48145,
            -1024.0,
            -148.68604,
            -1024.0,
            -151.89648,
            -1024.0,
            -155.10718,
            -1024.0,
            -158.32349,
            -1024.0,
            -161.54321,
            -1024.0,
            -164.76367,
            -1024.0,
            -167.9873,
            -1024.0,
            -171.21484,
            -1024.0,
            -174.44507,
            -1024.0,
            -177.68066,
            -1024.0,
            -180.91968,
            -1024.0,
            -184.15991,
            -1024.0,
            -187.40723,
            -1024.0,
            -190.65625,
            -1024.0,
            -193.91016,
            -1024.0,
            -197.16504,
            -1024.0,
            -200.42871,
            -1024.0,
            -203.68604,
            -1024.0,
            -206.95874,
            -1024.0,
            -210.2251,
            -1024.0,
            -213.50122,
            -1024.0,
            -216.78174,
            -1024.0,
            -220.0664,
            -1024.0,
            -223.35767,
            -1024.0,
            -226.6482,
            -1024.0,
            -229.94727,
            -1024.0,
            -233.24756,
            -1024.0,
            -236.55664,
            -1024.0,
            -239.86572,
            -1024.0,
            -243.1836,
            -1024.0,
            -246.50574,
            -1024.0,
            -249.828,
            -1024.0,
            -253.16638,
            -1024.0,
            -256.49927,
            -1024.0,
            -259.83887,
            -1024.0,
            -263.1864,
            -1024.0,
            -266.53796,
            -1024.0,
            -269.8955,
            -1024.0,
            -273.25647,
            -1024.0,
            -276.62756,
            -1024.0,
            -279.99915,
            -1024.0,
            -283.37854,
            -1024.0,
            -286.76428,
            -1024.0,
            -290.1543,
            -1024.0,
            -293.55237,
            -1024.0,
            -296.95508,
            -1024.0,
            -300.3617,
            -1024.0,
            -303.77405,
            -1024.0,
            -307.19873,
            -1024.0,
            -310.62708,
            -1024.0,
            -314.05957,
            -1024.0,
            -317.50208,
            -1024.0,
            -320.94897,
            -1024.0,
            -324.4004,
            -1024.0,
            -327.86145,
            -1024.0,
            -331.32947,
            -1024.0,
            -334.8047,
            -1024.0,
            -338.2837,
            -1024.0,
            -341.76917,
            -1024.0,
            -345.26685,
            -1024.0,
            -348.77112,
            -1024.0,
            -352.27893,
            -1024.0,
            -355.79724,
            -1024.0,
            -359.323,
            -1024.0,
            -362.8473,
            -1024.0,
            -366.39294,
            -1024.0,
            -369.9364,
            -1024.0,
            -373.49487,
            -1024.0,
            -377.05945,
            -1024.0,
            -380.6306,
            -1024.0,
            -384.20996,
            -1024.0,
            -387.79846,
            -1024.0,
            -391.39282,
            -1024.0,
            -395.00098,
            -1024.0,
            -398.61084,
            -1024.0,
            -402.2339,
            -1024.0,
            -405.8662,
            -1024.0,
            -409.50403,
            -1024.0,
            -413.151,
            -1024.0,
            -416.81445,
            -1024.0,
            -420.48218,
            -1024.0,
            -424.15466,
            -1024.0,
            -427.84106,
            -1024.0,
            -431.53198,
            -1024.0,
            -435.2378,
            -1024.0,
            -438.95398,
            -1024.0,
            -442.677,
            -1024.0,
            -446.41138,
            -1024.0,
            -450.15283,
            -1024.0,
            -453.90796,
            -1024.0,
            -457.6715,
            -1024.0,
            -461.44714,
            -1024.0,
            -465.22913,
            -1024.0,
            -469.02612,
            -1024.0,
            -472.83118,
            -1024.0,
            -476.64832,
            -1024.0,
            -480.48022,
            -1024.0,
            -484.31567,
            -1024.0,
            -488.16968,
            -1024.0,
            -492.02856,
            -1024.0,
            -495.89856,
            -1024.0,
            -499.7843,
            -1024.0,
            -503.67932,
            -1024.0,
            -507.58716,
            -1024.0,
            -511.50745,
            -1024.0,
            -515.4381,
            -1024.0,
            -519.3816,
            -1024.0,
            -523.33704,
            -1024.0,
            -527.3058,
            -1024.0,
            -531.2882,
            -1024.0,
            -535.281,
            -1024.0,
            -539.2899,
            -1024.0,
            -543.306,
            -1024.0,
            -547.3391,
            -1024.0,
            -551.38684,
            -1024.0,
            -555.4446,
            -1024.0,
            -559.5156,
            -1024.0,
            -563.60364,
            -1024.0,
            -567.70435,
            -1024.0,
            -571.8196,
            -1024.0,
            -575.94727,
            -1024.0,
            -580.0886,
            -1024.0,
            -584.2435,
            -1024.0,
            -588.41736,
            -1024.0,
            -592.6017,
            -1024.0,
            -596.8053,
            -1024.0,
            -601.0199,
            -1024.0,
            -605.25183,
            -1024.0,
            -609.5005,
            -1024.0,
            -613.7623,
            -1024.0,
            -618.0399,
            -1024.0,
            -622.33496,
            -1024.0,
            -626.64514,
            -1024.0,
            -630.97,
            -1024.0,
            -635.31384,
            -1024.0,
            -639.6743,
            -1024.0,
            -644.0476,
            -1024.0,
            -648.4419,
            -1024.0,
            -652.854,
            -1024.0,
            -657.2799,
            -1024.0,
            -661.724,
            -1024.0,
            -666.18884,
            -1024.0,
            -670.6666,
            -1024.0,
            -675.16724,
            -1024.0,
            -679.687,
            -1024.0,
            -684.21484,
            -1024.0,
            -688.7667,
            -1024.0,
            -693.344,
            -1024.0,
            -697.9315,
            -1024.0,
            -702.54285,
            -1024.0,
            -707.173,
            -1024.0,
            -711.8241,
            -1024.0,
            -716.4918,
            -1024.0,
            -721.18225,
            -1024.0,
            -725.89404,
            -1024.0,
            -730.62354,
            -1024.0,
            -735.374,
            -1024.0,
            -740.1461,
            -1024.0,
            -744.9396,
            -1024.0,
            -749.7551,
            -1024.0,
            -754.5901,
            -1024.0,
            -759.44995,
            -1024.0,
            -764.3307,
            -1024.0,
            -769.23254,
            -1024.0,
            -774.15796,
            -1024.0,
            -779.10767,
            -1024.0,
            -784.0813,
            -1024.0,
            -789.0741,
            -1024.0,
            -794.0968,
            -1024.0,
            -799.1372,
            -1024.0,
            -804.20447,
            -1024.0,
            -809.29614,
            -1024.0,
            -814.4126,
            -1024.0,
            -819.5525,
            -1024.0,
            -824.7189,
            -1024.0,
            -829.911,
            -1024.0,
            -835.1227,
            -1024.0,
            -840.37537,
            -1024.0,
            -845.64526,
            -1024.0,
            -850.9447,
            -1024.0,
            -856.2683,
            -1024.0,
            -861.6218,
            -1024.0,
            -867.0017,
            -1024.0,
            -872.4087,
            -1024.0,
            -877.84204,
            -1024.0,
            -883.3087,
            -1024.0,
            -888.8015,
            -1024.0,
            -894.3247,
            -1024.0,
            -899.8773,
            -1024.0,
            -905.46204,
            -1024.0,
            -911.0736,
            -1024.0,
            -916.71765,
            -1024.0,
            -922.39795,
            -1024.0,
            -928.0991,
            -1024.0,
            -933.8396,
            -1024.0,
            -939.6089,
            -1024.0,
            -945.41064,
            -1024.0,
            -951.2466,
            -1024.0,
            -957.1177,
            -1024.0,
            -963.01855,
            -1024.0,
            -968.95605,
            -1024.0,
            -974.927,
            -1024.0,
            -980.93225,
            -1024.0,
            -986.9772,
            -1024.0,
            -993.05396,
            -1024.0,
            -999.1699,
            -1024.0,
            -1005.3203,
            -1024.0,
            -1011.51196,
            -1024.0,
            -1017.71094,
            -1024.0,
            -1024.0,
            -1024.0,
            -1030.3086,
            -1024.0,
            -1036.6481,
            -1024.0,
            -1043.0245,
            -1024.0,
            -1049.4471,
            -1024.0,
            -1055.9087,
            -1024.0,
            -1062.4104,
            -1024.0,
            -1068.957,
            -1024.0,
            -1075.5417,
            -1024.0,
            -1082.1688,
            -1024.0,
            -1088.8416,
            -1024.0,
            -1095.5571,
            -1024.0,
            -1102.3187,
            -1024.0,
            -1109.1226,
            -1024.0,
            -1115.9734,
            -1024.0,
            -1122.8689,
            -1024.0,
            -1129.8097,
            -1024.0,
            -1136.8018,
            -1024.0,
            -1143.8352,
            -1024.0,
            -1150.9216,
            -1024.0,
            -1158.0577,
            -1024.0,
            -1165.242,
            -1024.0,
            -1172.4761,
            -1024.0,
            -1179.7638,
            -1024.0,
            -1187.1012,
            -1024.0,
            -1194.4913,
            -1024.0,
            -1201.9343,
            -1024.0,
            -1209.4314,
            -1024.0,
            -1216.9813,
            -1024.0,
            -1224.5869,
            -1024.0,
            -1232.252,
            -1024.0,
            -1239.9706,
            -1024.0,
            -1247.7474,
            -1024.0,
            -1255.5808,
            -1024.0,
            -1263.475,
            -1024.0,
            -1271.4327,
            -1024.0,
            -1279.448,
            -1024.0,
            -1287.526,
            -1024.0,
            -1295.6637,
            -1024.0,
            -1303.8634,
            -1024.0,
            -1312.1355,
            -1024.0,
            -1320.4677,
            -1024.0,
            -1328.8668,
            -1024.0,
            -1337.3346,
            -1024.0,
            -1345.8673,
            -1024.0,
            -1354.4692,
            -1024.0,
            -1363.1443,
            -1024.0,
            -1371.8873,
            -1024.0,
            -1380.7043,
            -1024.0,
            -1389.5967,
            -1024.0,
            -1398.5568,
            -1024.0,
            -1407.5984,
            -1024.0,
            -1416.7141,
            -1024.0,
            -1425.9082,
            -1024.0,
            -1435.1824,
            -1024.0,
            -1444.536,
            -1024.0,
            -1453.968,
            -1024.0,
            -1463.4819,
            -1024.0,
            -1473.0851,
            -1024.0,
            -1482.7721,
            -1024.0,
            -1492.5427,
            -1024.0,
            -1502.4019,
            -1024.0,
            -1512.3505,
            -1024.0,
            -1522.3896,
            -1024.0,
            -1532.5242,
            -1024.0,
            -1542.7461,
            -1024.0,
            -1553.0695,
            -1024.0,
            -1563.4875,
            -1024.0,
            -1574.0009,
            -1024.0,
            -1584.6156,
            -1024.0,
            -1595.3318,
            -1024.0,
            -1606.1482,
            -1024.0,
            -1617.072,
            -1024.0,
            -1628.1024,
            -1024.0,
            -1639.2394,
            -1024.0,
            -1650.4882,
            -1024.0,
            -1661.8455,
            -1024.0,
            -1673.318,
            -1024.0,
            -1684.9084,
            -1024.0,
            -1696.6132,
            -1024.0,
            -1708.4404,
            -1024.0,
            -1720.3892,
            -1024.0,
            -1732.4608,
            -1024.0,
            -1744.6586,
            -1024.0,
            -1756.9823,
            -1024.0,
            -1769.4386,
            -1024.0,
            -1782.0283,
            -1024.0,
            -1794.75,
            -1024.0,
            -1807.6128,
            -1024.0,
            -1820.6163,
            -1024.0,
            -1833.7578,
            -1024.0,
            -1847.0505,
            -1024.0,
            -1860.4866,
            -1024.0,
            -1874.074,
            -1024.0,
            -1887.8181,
            -1024.0,
            -1901.7202,
            -1024.0,
            -1915.7693,
            -1024.0,
            -1929.9922,
            -1024.0,
            -1944.3734,
            -1024.0,
            -1958.9279,
            -1024.0,
            -1973.6516,
            -1024.0,
            -1988.5531,
            -1024.0,
            -2003.6306,
            -1024.0,
            -2018.8914,
            -1024.0,
            -2034.3386,
            -1024.0,
            -2049.9736,
            -1024.0,
            -2065.803,
            -1024.0,
            -2081.8298,
            -1024.0,
            -2098.058,
            -1024.0,
            -2114.491,
            -1024.0,
            -2131.1333,
            -1024.0,
            -2147.9854,
            -1024.0,
            -2165.066,
            -1024.0,
            -2182.3628,
            -1024.0,
            -2199.8901,
            -1024.0,
            -2217.6494,
            -1024.0,
            -2235.643,
            -1024.0,
            -2253.8784,
            -1024.0,
            -2272.37,
            -1024.0,
            -2291.109,
            -1024.0,
            -2310.106,
            -1024.0,
            -2329.3706,
            -1024.0,
            -2348.9048,
            -1024.0,
            -2368.7148,
            -1024.0,
            -2388.8071,
            -1024.0,
            -2409.1946,
            -1024.0,
            -2429.873,
            -1024.0,
            -2450.851,
            -1024.0,
            -2472.1548,
            -1024.0,
            -2493.7737,
            -1024.0,
            -2515.7085,
            -1024.0,
            -2537.9749,
            -1024.0,
            -2560.588,
            -1024.0,
            -2583.5469,
            -1024.0,
            -2606.872,
            -1024.0,
            -2630.5596,
            -1024.0,
            -2654.6199,
            -1024.0,
            -2679.0662,
            -1024.0,
            -2703.914,
            -1024.0,
            -2729.1646,
            -1024.0,
            -2754.8325,
            -1024.0,
            -2780.9277,
            -1024.0,
            -2807.459,
            -1024.0,
            -2834.4434,
            -1024.0,
            -2861.8882,
            -1024.0,
            -2889.8064,
            -1024.0,
            -2918.2168,
            -1024.0,
            -2947.1233,
            -1024.0,
            -2976.5496,
            -1024.0,
            -3006.5007,
            -1024.0,
            -3037.002,
            -1024.0,
            -3068.058,
            -1024.0,
            -3099.6929,
            -1024.0,
            -3131.919,
            -1024.0,
            -3164.7568,
            -1024.0,
            -3198.226,
            -1024.0,
            -3232.3374,
            -1024.0,
            -3267.1196,
            -1024.0,
            -3302.59,
            -1024.0,
            -3338.7622,
            -1024.0,
            -3375.6753,
            -1024.0,
            -3413.3389,
            -1024.0,
            -3451.7783,
            -1024.0,
            -3491.024,
            -1024.0,
            -3531.1,
            -1024.0,
            -3572.0327,
            -1024.0,
            -3613.8481,
            -1024.0,
            -3656.5796,
            -1024.0,
            -3700.2603,
            -1024.0,
            -3744.9197,
            -1024.0,
            -3790.5898,
            -1024.0,
            -3837.3135,
            -1024.0,
            -3885.121,
            -1024.0,
            -3934.0537,
            -1024.0,
            -3984.1565,
            -1024.0,
            -4035.4707,
            -1024.0,
            -4088.0376,
            -1024.0,
            -4141.91,
            -1024.0,
            -4197.136,
            -1024.0,
            -4253.7676,
            -1024.0,
            -4311.8613,
            -1024.0,
            -4371.4766,
            -1024.0,
            -4432.675,
            -1024.0,
            -4495.516,
            -1024.0,
            -4560.078,
            -1024.0,
            -4626.429,
            -1024.0,
            -4694.6426,
            -1024.0,
            -4764.8066,
            -1024.0,
            -4836.997,
            -1024.0,
            -4911.3164,
            -1024.0,
            -4987.8423,
            -1024.0,
            -5066.708,
            -1024.0,
            -5147.9956,
            -1024.0,
            -5231.833,
            -1024.0,
            -5318.339,
            -1024.0,
            -5407.6514,
            -1024.0,
            -5499.8945,
            -1024.0,
            -5595.234,
            -1024.0,
            -5693.8247,
            -1024.0,
            -5795.836,
            -1024.0,
            -5901.457,
            -1024.0,
            -6010.8794,
            -1024.0,
            -6124.3135,
            -1024.0,
            -6241.9897,
            -1024.0,
            -6364.1475,
            -1024.0,
            -6491.055,
            -1024.0,
            -6622.999,
            -1024.0,
            -6760.2817,
            -1024.0,
            -6903.2466,
            -1024.0,
            -7052.245,
            -1024.0,
            -7207.6797,
            -1024.0,
            -7369.9746,
            -1024.0,
            -7539.5967,
            -1024.0,
            -7717.0576,
            -1024.0,
            -7902.925,
            -1024.0,
            -8097.8027,
            -1024.0,
            -8302.373,
            -1024.0,
            -8517.382,
            -1024.0,
            -8743.648,
            -1024.0,
            -8982.09,
            -1024.0,
            -9233.717,
            -1024.0,
            -9499.665,
            -1024.0,
            -9781.197,
            -1024.0,
            -10079.713,
            -1024.0,
            -10396.846,
            -1024.0,
            -10734.362,
            -1024.0,
            -11094.302,
            -1024.0,
            -11478.994,
            -1024.0,
            -11891.096,
            -1024.0,
            -12333.643,
            -1024.0,
            -12810.15,
            -1024.0,
            -13324.69,
            -1024.0,
            -13882.028,
            -1024.0,
            -14487.735,
            -1024.0,
            -15148.413,
            -1024.0,
            -15871.912,
            -1024.0,
            -16667.656,
            -1024.0,
            -17547.055,
            -1024.0,
            -18524.04,
            -1024.0,
            -19615.852,
            -1024.0,
            -20843.998,
            -1024.0,
            -22235.764,
            -1024.0,
            -23826.203,
            -1024.0,
            -25661.162,
            -1024.0,
            -27801.773,
            -1024.0,
            -30331.398,
            -1024.0,
            -33366.742,
            -1024.0,
            -37076.36,
            -1024.0,
            -41713.133,
            -1024.0,
            -47674.4,
            -1024.0,
            -55622.4,
            -1024.0,
            -66749.19,
            -1024.0,
            -83438.83,
            -1024.0,
            -111254.22,
            -1024.0,
            -166883.95,
            -1024.0,
            -333771.03,
        ];

        for i in 0..buffer.len() {
            let a = buffer[i].im + buffer[i].re;
            let b = expected[i * 2] + expected[i * 2 + 1];
            if a != b {
                println!("{} != {}, index: {}", a, b, i);
            }
        }
    }
}
